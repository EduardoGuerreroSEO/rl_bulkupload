<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SEO XML Generator</title>
  <meta name="robots" content="noindex,nofollow">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { rl: { navy: '#1D2F4E', gold: '#B5A07E' } },
          boxShadow: { soft: '0 10px 20px rgba(0,0,0,.06), 0 6px 6px rgba(0,0,0,.06)' },
          borderRadius: { xl: '1rem', '2xl': '1.25rem' }
        }
      }
    }
  </script>

  <!-- Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <!-- Prism -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .file-label.dragover { background: rgba(29,47,78,.06); border-color: #1D2F4E; }
    .modal-content { max-height: 70vh; }

    /* Background after login: subtle image overlay @ 20% on white base */
    body.bg-after-login {
      background: #ffffff; /* base white */
      position: relative;
      overflow-x: hidden;
    }
    body.bg-after-login::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background-image: url('./background.avif');
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      opacity: 0.2; /* ~20% */
      pointer-events: none;
    }
  </style>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
</head>
<body class="bg-white text-gray-900">

  <!-- LOGIN (client side; obfuscated with SHA-256 + Base64) -->
  <div id="login-overlay" class="fixed inset-0 bg-rl-navy/95 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-soft w-full max-w-md p-8 border border-rl-gold/40">
      <h1 class="text-2xl font-bold text-rl-navy">SEO XML Generator</h1>
      <p class="text-sm text-gray-600 mt-1">Restricted access</p>
      <form id="login-form" class="mt-6 space-y-4">
        <div>
          <label class="text-sm font-medium text-gray-700">Username</label>
          <input id="login-user" type="text" class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rl-gold" placeholder="Username" autocomplete="username"/>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Password</label>
          <input id="login-pass" type="password" class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rl-gold" placeholder="********" autocomplete="current-password"/>
        </div>
        <div class="flex items-center justify-between">
          <label class="flex items-center gap-2 text-sm text-gray-600">
            <input id="remember-me" type="checkbox" class="rounded border-gray-300 text-rl-navy focus:ring-rl-gold"/> Remember me
          </label>
          <button class="bg-rl-navy text-white px-4 py-2 rounded-lg hover:opacity-90" type="submit">Enter</button>
        </div>
        <p id="login-error" class="text-red-600 text-sm hidden">Invalid credentials.</p>
      </form>
    </div>
  </div>

  <div class="container mx-auto p-4 md:p-8 max-w-6xl">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-extrabold text-rl-navy">SEO XML Generator</h1>
      <p class="text-gray-600 mt-2">Convert CSV data to market-specific XML feeds for SFCC.</p>
    </header>

    <div class="flex flex-col gap-8">
      <main class="bg-white border border-rl-gold/40 p-6 md:p-8 rounded-2xl shadow-soft">
        <!-- Region + Mode -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-lg font-semibold text-rl-navy mb-3">1. Select Region</label>
            <div class="flex gap-4">
              <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-rl-navy/5 has-[:checked]:border-rl-navy">
                <input type="radio" name="region" value="EU" class="w-5 h-5 text-rl-navy" checked>
                <span class="ml-3 text-lg font-medium">EU</span>
              </label>
              <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-rl-navy/5 has-[:checked]:border-rl-navy">
                <input type="radio" name="region" value="ME" class="w-5 h-5 text-rl-navy">
                <span class="ml-3 text-lg font-medium">ME</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-lg font-semibold text-rl-navy mb-3">Mode</label>
            <div class="flex gap-4">
              <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-rl-navy/5 has-[:checked]:border-rl-navy">
                <input type="radio" name="mode" value="simple" class="w-5 h-5 text-rl-navy" checked>
                <span class="ml-3 text-lg font-medium">Simple (title, description, H1)</span>
              </label>
              <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-rl-navy/5 has-[:checked]:border-rl-navy">
                <input type="radio" name="mode" value="facets" class="w-5 h-5 text-rl-navy">
                <span class="ml-3 text-lg font-medium">Facets (adds refined fields)</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Upload -->
        <div class="mt-6">
          <label class="block text-lg font-semibold text-rl-navy mb-3">2. Upload Files</label>
          <label id="drop-zone" class="file-label flex flex-col items-center justify-center w-full h-36 px-4 text-center border-2 border-dashed rounded-xl cursor-pointer bg-white">
            <svg class="w-8 h-8 mb-3 text-rl-navy" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
            <p class="mb-2 text-sm text-gray-600"><span class="font-semibold">Click to upload</span> or drag and drop</p>
          </label>
          <input id="file-upload" type="file" class="hidden" multiple accept=".xlsx,.xls"/>
        </div>

        <!-- File list -->
        <div id="file-list-container" class="space-y-2 mt-6 hidden">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg font-semibold text-rl-navy">File Queue</h3>
            <button id="clear-btn" class="text-sm text-rl-navy hover:underline">Clear All</button>
          </div>
          <div id="file-list" class="space-y-2"></div>
        </div>

        <!-- Generate -->
        <div class="mt-6">
          <button id="generate-btn" class="w-full bg-rl-navy text-white font-semibold py-3 px-4 rounded-xl hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-rl-gold disabled:bg-gray-400 disabled:cursor-not-allowed transition flex items-center justify-center">
            <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span id="generate-btn-text">Generate & Download ZIP</span>
          </button>
        </div>

        <!-- Advanced -->
        <details id="advanced" class="mt-4 border rounded-xl p-4 open:shadow-soft">
          <summary class="cursor-pointer select-none font-semibold text-rl-navy">Advanced Options — select markets</summary>
          <p class="text-sm text-gray-600 mt-2">
            All markets from the selected region are listed below, grouped by language.
          </p>
          <div id="market-checkboxes" class="grid gap-3 mt-4"></div>
        </details>

        <!-- Status -->
        <div id="status" class="mt-6 text-center text-sm"></div>
      </main>

      <aside class="bg-white border border-rl-gold/40 p-6 md:p-8 rounded-2xl shadow-soft space-y-6">
        <div>
          <h3 class="text-lg font-semibold text-rl-navy mb-2">Required CSV Headers</h3>
          <p class="text-sm text-gray-600">
            Required:
            <code class="px-2 py-0.5 bg-gray-100 rounded">cgid</code>
            <code class="px-2 py-0.5 bg-gray-100 rounded">title</code>
            <code class="px-2 py-0.5 bg-gray-100 rounded">desc</code>
            <code class="px-2 py-0.5 bg-gray-100 rounded">h1</code>.
            Optional (Facets):
            <code class="px-2 py-0.5 bg-gray-100 rounded">ref_title</code>,
            <code class="px-2 py-0.5 bg-gray-100 rounded">ref_desc</code>,
            <code class="px-2 py-0.5 bg-gray-100 rounded">ref_h1</code>.
          </p>
          <button id="download-template" class="mt-3 text-sm text-rl-navy underline">Download CSV template</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal preview -->
  <div id="preview-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-40 hidden">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl flex flex-col">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 class="text-xl font-bold text-rl-navy">XML Preview</h3>
        <button id="modal-close-btn" class="text-gray-500 hover:text-gray-900 text-3xl leading-none">&times;</button>
      </div>
      <div class="p-4 modal-content overflow-y-auto">
        <pre class="line-numbers"><code id="modal-content-code" class="language-xml"></code></pre>
      </div>
    </div>
  </div>

  <script>
    /* ---------- LOGIN (hash + base64) ---------- */
    // SHA-256 (hex) of:  rl_salt_v1|eduardo:guerrero
    const B64_HASH = 'NmVhYzBmMmY1NDQ1YjhlYmJmYzI2OTNlMmEwODc0MjQzOWQ2Nzc5MTJmNDc4M2E2ODI1NGUyNTcyYzEwNmRmOA==';
    const SALT = 'rl_salt_v1|';

    const loginOverlay = document.getElementById('login-overlay');
    const loginForm = document.getElementById('login-form');
    const loginUser = document.getElementById('login-user');
    const loginPass  = document.getElementById('login-pass');
    const loginErr   = document.getElementById('login-error');
    const rememberMe = document.getElementById('remember-me');

    if (localStorage.getItem('rl_xml_auth') === 'ok') {
      loginOverlay.classList.add('hidden');
      document.body.classList.add('bg-after-login'); // subtle background
    }

    async function sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      const bytes = Array.from(new Uint8Array(buf));
      return bytes.map(b => b.toString(16).padStart(2,'0')).join('');
    }
    function b64decodeToText(b64){ try { return atob(b64); } catch { return ''; } }

    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const targetHex = b64decodeToText(B64_HASH); // expected hash (hex)
      const inputHex  = await sha256Hex(`${SALT}${loginUser.value}:${loginPass.value}`);
      if (targetHex && inputHex === targetHex) {
        loginErr.classList.add('hidden');
        if (rememberMe.checked) localStorage.setItem('rl_xml_auth', 'ok');
        loginOverlay.classList.add('hidden');
        document.body.classList.add('bg-after-login'); // add subtle background after login
      } else {
        loginErr.classList.remove('hidden');
      }
    });

    /* ---------- CONSTANTS & STATE ---------- */
    const XML_NAMESPACE="http://www.demandware.com/xml/impex/catalog/2006-10-31";
    const REQUIRED_HEADERS=['cgid','title','desc','h1'];
    const OPTIONAL_HEADERS=['ref_title','ref_desc','ref_h1'];

    // EU placeholders (including PL and SE)
    const EU_PLACEHOLDER_CODES = ['UK','DE','ES','FR','IT','NL','PT','PL','SE'];
    const EU_CURRENCY_PLACEHOLDER = '£';
    const ME_PLACEHOLDER = '{{MARKET_BRAND}}';
    const ME_LEGACY_TOKEN = { EN: 'Ralph Lauren® SA', AR: 'رالف لورين® س.ع' };

    let EU_MARKETS = null; // from markets_eu.json
    let ME_MARKETS = null; // from markets_me.json
    let fileStore = [];

    /* ---------- ELEMENTS ---------- */
    const fileInput=document.getElementById('file-upload');
    const dropZone=document.getElementById('drop-zone');
    const fileListContainer=document.getElementById('file-list-container');
    const fileListDisplay=document.getElementById('file-list');
    const clearBtn=document.getElementById('clear-btn');
    const generateBtn=document.getElementById('generate-btn');
    const spinner=document.getElementById('spinner');
    const generateBtnText=document.getElementById('generate-btn-text');
    const statusDiv=document.getElementById('status');
    const modal=document.getElementById('preview-modal');
    const modalCloseBtn=document.getElementById('modal-close-btn');
    const modalContentCode=document.getElementById('modal-content-code');
    const marketBox=document.getElementById('market-checkboxes');
    const downloadTemplateBtn=document.getElementById('download-template');

    /* ---------- LOAD JSON (no fallback) ---------- */
    async function loadMarketJsons(){
      const fail = (msg) => {
        showStatus(msg, 'error');
        generateBtn.disabled = true;
      };
      try{
        const [euRes, meRes] = await Promise.all([ fetch('markets_eu.json'), fetch('markets_me.json') ]);
        if (!euRes.ok) return fail('Failed to load markets_eu.json. Make sure it is placed next to this HTML.');
        if (!meRes.ok) return fail('Failed to load markets_me.json. Make sure it is placed next to this HTML.');
        const [eu, me] = await Promise.all([ euRes.json(), meRes.json() ]);
        if (!eu || typeof eu !== 'object') return fail('Invalid markets_eu.json format.');
        if (!me || typeof me !== 'object') return fail('Invalid markets_me.json format.');
        EU_MARKETS = eu;
        ME_MARKETS = me;
        generateBtn.disabled = false;
        populateMarketPicker();
      }catch(e){
        fail('Unable to load market JSON files. Check console and file paths.');
        console.error(e);
      }
    }
    loadMarketJsons();

    /* ---------- UI EVENTS ---------- */
    fileInput.addEventListener('change',e=>addFilesToQueue(e.target.files));
    clearBtn.addEventListener('click',clearFiles);
    generateBtn.addEventListener('click',handleGeneration);
    modalCloseBtn.addEventListener('click',()=>modal.classList.add('hidden'));
    dropZone.addEventListener('click',()=>fileInput.click());
    dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('dragover');});
    dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop',e=>{e.preventDefault();dropZone.classList.remove('dragover');addFilesToQueue(e.dataTransfer.files);});
    document.addEventListener('change',e=>{
      if(e.target.name==='region') populateMarketPicker();
      if(e.target.name==='mode')   populateMarketPicker(); // mode doesn’t filter markets, but keep UI reactive
    });
    fileListDisplay.addEventListener('click',e=>{
      if(e.target.closest('.preview-btn')){
        const id=e.target.closest('.file-item').dataset.id;
        handlePreview(id);
      }
    });
    downloadTemplateBtn.addEventListener('click',()=>{
      const csv='cgid,title,desc,h1,ref_title,ref_desc,ref_h1\nmen-clothing-poloshirts,"Polo Shirts for Men | Ralph Lauren® UK","Shop today and get free returns.","Category H1","Refined Title","Refined Description","Refined H1"';
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      saveAs(blob,'template.csv');
    });

    /* ---------- HELPERS ---------- */
    const escapeXml = s => typeof s==='string' ? s.replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','\'':'&apos;','"':'&quot;'}[c])) : '';
    const escapeReg = s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const replaceCodesSafely = (text,codesMap)=>{
      if(!text) return '';
      let out=text;
      Object.keys(codesMap).forEach(code=>{
        const re=new RegExp(`\\b${code}\\b`,'g');
        out=out.replace(re,codesMap[code]);
      });
      return out;
    };
    const replaceCurrency = (text,placeholder,to)=> text ? text.replace(new RegExp(escapeReg(placeholder),'g'), to) : '';

    function showStatus(message,type='info'){
      statusDiv.textContent=message;
      statusDiv.className='mt-6 text-center text-sm';
      if(type==='success') statusDiv.classList.add('text-green-700');
      else if(type==='error') statusDiv.classList.add('text-red-600');
      else statusDiv.classList.add('text-gray-600');
    }
    function toggleLoading(isLoading,msg){
      generateBtn.disabled=isLoading;
      generateBtnText.textContent=isLoading?msg:'Generate & Download ZIP';
      spinner.classList.toggle('hidden',!isLoading);
    }
    function getFormattedDate(){
      const d=new Date();
      return `${String(d.getDate()).padStart(2,'0')}_${String(d.getMonth()+1).padStart(2,'0')}_${d.getFullYear()}`;
    }

    /* ---------- FILE QUEUE ---------- */
    function addFilesToQueue(files){
      Array.from(files).forEach(file=>{
        if(!fileStore.some(i=>i.file.name===file.name && i.file.size===file.size)){
          fileStore.push({ id:`file-${Date.now()}-${file.name}`, file, status:'pending', message:'' });
        }
      });
      updateFileListUI();
    }
    function updateFileListUI(){
      fileListContainer.classList.toggle('hidden', fileStore.length===0);
      fileListDisplay.innerHTML='';
      fileStore.forEach(item=>{
        const row=document.createElement('div');
        row.dataset.id=item.id;
        row.className='file-item flex items-center justify-between bg-gray-50 border rounded-xl p-2';
        const icon=item.status==='success'?'text-green-600': item.status==='error'?'text-red-600':'text-gray-400';
        row.innerHTML=`
          <div class="flex items-center gap-3">
            <svg class="w-5 h-5 ${icon}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v8m-4-4h8"/></svg>
            <span class="text-sm font-medium truncate">${item.file.name}</span>
          </div>
          <button class="preview-btn text-xs bg-white border px-2 py-1 rounded-md hover:bg-gray-100">Preview</button>`;
        fileListDisplay.appendChild(row);
        if(item.status==='error' && item.message){
          const p=document.createElement('p');
          p.className='text-xs text-red-600 ml-8 -mt-1';
          p.textContent=item.message;
          fileListDisplay.appendChild(p);
        }
      });
    }
    function clearFiles(){ fileStore=[]; fileInput.value=''; updateFileListUI(); showStatus(''); }

    /* ---------- REGION / ADVANCED MARKETS ---------- */
    function currentRegion(){ return document.querySelector('input[name="region"]:checked').value; }

    function populateMarketPicker(){
      const region=currentRegion();
      marketBox.innerHTML='';

      if(region==='EU'){
        if(!EU_MARKETS || Object.keys(EU_MARKETS).length===0){
          marketBox.innerHTML='<p class="text-sm text-red-600">EU markets not loaded. Ensure markets_eu.json is available.</p>';
          return;
        }
        Object.entries(EU_MARKETS).forEach(([langKey, markets])=>{
          const group=document.createElement('div');
          group.className='border rounded-lg p-3';
          group.innerHTML=`
            <div class="flex items-center justify-between">
              <h4 class="font-semibold text-sm text-rl-navy">${langKey}</h4>
              <div class="space-x-2">
                <button type="button" class="text-xs underline" data-langkey="${langKey}" data-act="all">All</button>
                <button type="button" class="text-xs underline" data-langkey="${langKey}" data-act="none">None</button>
              </div>
            </div>
            <div class="mt-2 grid sm:grid-cols-2 lg:grid-cols-3 gap-2" id="box-${langKey}"></div>`;
          marketBox.appendChild(group);

          const box=group.querySelector(`#box-${langKey}`);
          markets.forEach(m=>{
            const el=document.createElement('label');
            el.className='flex items-center gap-2 p-2 border rounded-lg';
            el.innerHTML=`
              <input type="checkbox" class="mkt-check"
                     data-region="EU"
                     data-langkey="${langKey}"
                     data-code="${m.Code}"
                     data-lang="${m.Lang}"
                     data-cur="${m.Currency}" checked>
              <span class="text-sm">${m.Code} <span class="text-gray-500">(${m.Lang})</span></span>`;
            box.appendChild(el);
          });
        });
      } else {
        if(!ME_MARKETS || Object.keys(ME_MARKETS).length===0){
          marketBox.innerHTML='<p class="text-sm text-red-600">ME markets not loaded. Ensure markets_me.json is available.</p>';
          return;
        }
        Object.entries(ME_MARKETS).forEach(([langKey,codesObj])=>{
          const group=document.createElement('div');
          group.className='border rounded-lg p-3';
          group.innerHTML=`
            <div class="flex items-center justify-between">
              <h4 class="font-semibold text-sm text-rl-navy">${langKey}</h4>
              <div class="space-x-2">
                <button type="button" class="text-xs underline" data-langkey="${langKey}" data-act="all">All</button>
                <button type="button" class="text-xs underline" data-langkey="${langKey}" data-act="none">None</button>
              </div>
            </div>
            <div class="mt-2 grid sm:grid-cols-3 lg:grid-cols-4 gap-2" id="box-${langKey}"></div>`;
          marketBox.appendChild(group);

          const box=group.querySelector(`#box-${langKey}`);
          Object.keys(codesObj).forEach(code=>{
            const el=document.createElement('label');
            el.className='flex items-center gap-2 p-2 border rounded-lg';
            el.innerHTML=`
              <input type="checkbox" class="mkt-check"
                     data-region="ME"
                     data-langkey="${langKey}"
                     data-code="${code}" checked>
              <span class="text-sm">${code}</span>`;
            box.appendChild(el);
          });
        });
      }
    }

    // GLOBAL handler for All / None (works across re-renders)
    marketBox.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-act]');
      if (!btn) return;
      const langKey = btn.dataset.langkey;
      const check = btn.dataset.act === 'all';
      const checks = marketBox.querySelectorAll(`.mkt-check[data-langkey="${langKey}"]`);
      checks.forEach(c => { c.checked = check; });
    });

    function collectSelectionsEU(){
      const out={};
      document.querySelectorAll('.mkt-check[data-region="EU"]').forEach(c=>{
        if(c.checked){
          const k=c.dataset.langkey; out[k] ||= [];
          out[k].push({ Code:c.dataset.code, Lang:c.dataset.lang, Currency:c.dataset.cur });
        }
      });
      return out;
    }
    function collectSelectionsME(){
      const out={};
      document.querySelectorAll('.mkt-check[data-region="ME"]').forEach(c=>{
        const k=c.dataset.langkey; out[k] ||= {};
        if(c.checked) out[k][c.dataset.code] = ME_MARKETS?.[k]?.[c.dataset.code];
      });
      return out;
    }

    /* ---------- XLSX ---------- */
    function readFileAsJson(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>{
          try{
            const data=new Uint8Array(e.target.result);
            const wb=XLSX.read(data,{type:'array'});
            const ws=wb.Sheets[wb.SheetNames[0]];
            resolve(XLSX.utils.sheet_to_json(ws));
          }catch(err){ reject(new Error('Failed to parse the Excel file.')); }
        };
        reader.onerror=()=>reject(new Error('Failed to read the file.'));
        reader.readAsArrayBuffer(file);
      });
    }
    function validateHeaders(rows){
      if(!rows || rows.length===0) return {isValid:true,missing:[]};
      const headers=Object.keys(rows[0]);
      const missing=REQUIRED_HEADERS.filter(h=>!headers.includes(h));
      return {isValid:missing.length===0, missing};
    }

    /* ---------- XML RENDER ---------- */
    // IMPORTANT: always output tags, even if empty strings
    function createAggregatedCategory(cgid, entries, mode){
      const lines=[];
      lines.push(`    <category category-id="${escapeXml(cgid)}">`);
      lines.push('        <page-attributes>');
      entries.forEach(e=>{
        const t = e.title ?? '';
        const d = e.desc  ?? '';
        lines.push(`            <page-title xml:lang="${escapeXml(e.langCode)}">${escapeXml(t)}</page-title>`);
        lines.push(`            <page-description xml:lang="${escapeXml(e.langCode)}">${escapeXml(d)}</page-description>`);
      });
      lines.push('        </page-attributes>');
      lines.push('        <custom-attributes>');
      entries.forEach(e=>{
        const h  = e.h1 ?? '';
        // Facets fields are written when mode === 'facets' (even if empty)
        if(mode==='facets'){
          const rt = e.ref_title ?? '';
          const rd = e.ref_desc  ?? '';
          const rh = e.ref_h1    ?? '';
          lines.push(`            <custom-attribute xml:lang="${escapeXml(e.langCode)}" attribute-id="refinedPageTitle">${escapeXml(rt)}</custom-attribute>`);
          lines.push(`            <custom-attribute xml:lang="${escapeXml(e.langCode)}" attribute-id="refinedPageDescription">${escapeXml(rd)}</custom-attribute>`);
          lines.push(`            <custom-attribute xml:lang="${escapeXml(e.langCode)}" attribute-id="refinedPageH1Tag">${escapeXml(rh)}</custom-attribute>`);
        }
        lines.push(`            <custom-attribute xml:lang="${escapeXml(e.langCode)}" attribute-id="alternateH1Tag">${escapeXml(h)}</custom-attribute>`);
      });
      lines.push('        </custom-attributes>');
      lines.push('    </category>');
      return lines.join('\n');
    }

    function generateEuXml(rows, langKey, mode, selectedList, preview=false){
      if(!EU_MARKETS?.[langKey]) return '';
      const data = preview ? rows.slice(0,1) : rows;
      const markets = selectedList && selectedList.length ? selectedList : EU_MARKETS[langKey];

      const catMap=new Map();
      data.forEach(r=>{
        const cgid=r.cgid?String(r.cgid).trim():'';
        if(!cgid) return;
        const title=r.title?String(r.title).trim():'';
        const desc=r.desc?String(r.desc).trim():'';
        const h1=r.h1?String(r.h1).trim():'';
        const rt=r.ref_title?String(r.ref_title).trim():'';
        const rd=r.ref_desc?String(r.ref_desc).trim():'';
        const rh=r.ref_h1?String(r.ref_h1).trim():'';

        markets.forEach(m=>{
          const codesMap={}; EU_PLACEHOLDER_CODES.forEach(p=>codesMap[p]=m.Code);
          let T=replaceCurrency(replaceCodesSafely(title,codesMap),EU_CURRENCY_PLACEHOLDER,m.Currency);
          let D=replaceCurrency(replaceCodesSafely(desc,codesMap),EU_CURRENCY_PLACEHOLDER,m.Currency);
          let H=replaceCurrency(replaceCodesSafely(h1,codesMap),EU_CURRENCY_PLACEHOLDER,m.Currency);
          let RT=replaceCurrency(replaceCodesSafely(rt,codesMap),EU_CURRENCY_PLACEHOLDER,m.Currency);
          let RD=replaceCurrency(replaceCodesSafely(rd,codesMap),EU_CURRENCY_PLACEHOLDER,m.Currency);
          let RH=replaceCurrency(replaceCodesSafely(rh,codesMap),EU_CURRENCY_PLACEHOLDER,m.Currency);

          const entry={ langCode:m.Lang, title:T, desc:D, h1:H, ref_title:RT, ref_desc:RD, ref_h1:RH };
          if(!catMap.has(cgid)) catMap.set(cgid,[]);
          catMap.get(cgid).push(entry);
        });
      });

      if(!catMap.size) return '';
      const body=Array.from(catMap.entries()).map(([cgid,entries])=>createAggregatedCategory(cgid,entries,mode)).join('\n');
      return `<?xml version="1.0" encoding="UTF-8"?>\n<catalog xmlns="${XML_NAMESPACE}" catalog-id="siteCatalog_RalphLauren_EU">\n${body}\n</catalog>`;
    }

    function generateMeXml(rows, langKey, mode, selectedMap, preview=false){
      if(!ME_MARKETS?.[langKey]) return '';
      const data = preview ? rows.slice(0,1) : rows;
      const all = ME_MARKETS[langKey];
      const markets = selectedMap && Object.keys(selectedMap).length ? selectedMap : all;

      const catMap=new Map();
      data.forEach(r=>{
        const cgid=r.cgid?String(r.cgid).trim():'';
        if(!cgid) return;
        const title=r.title?String(r.title).trim():'';
        const desc=r.desc?String(r.desc).trim():'';
        const h1=r.h1?String(r.h1).trim():'';
        const rt=r.ref_title?String(r.ref_title).trim():'';
        const rd=r.ref_desc?String(r.ref_desc).trim():'';
        const rh=r.ref_h1?String(r.ref_h1).trim():'';

        Object.entries(markets).forEach(([code, brand])=>{
          const langCode=`${langKey.toLowerCase()}-${code}`;
          const applyBrand = (txt)=>{
            if(!txt) return '';
            return txt.includes(ME_PLACEHOLDER)
              ? txt.replaceAll(ME_PLACEHOLDER,brand)
              : txt.replaceAll(ME_LEGACY_TOKEN[langKey] || '', brand);
          };
          const entry={
            langCode,
            title:applyBrand(title),
            desc:applyBrand(desc),
            h1:applyBrand(h1),
            ref_title: mode==='facets' ? applyBrand(rt) : '',
            ref_desc:  mode==='facets' ? applyBrand(rd) : '',
            ref_h1:    mode==='facets' ? applyBrand(rh) : ''
          };
          if(!catMap.has(cgid)) catMap.set(cgid,[]);
          catMap.get(cgid).push(entry);
        });
      });

      if(!catMap.size) return '';
      const body=Array.from(catMap.entries()).map(([cgid,entries])=>createAggregatedCategory(cgid,entries,mode)).join('\n');
      return `<?xml version="1.0" encoding="UTF-8"?>\n<catalog xmlns="${XML_NAMESPACE}" catalog-id="siteCatalog_RalphLauren_ME">\n${body}\n</catalog>`;
    }

    /* ---------- ACTIONS ---------- */
    async function handleGeneration(){
      if(fileStore.length===0){ showStatus('Please upload at least one Excel file.', 'error'); return; }
      toggleLoading(true,'Processing files...');
      const region=currentRegion();
      const mode=document.querySelector('input[name="mode"]:checked').value;
      const zip=new JSZip(); let success=0;

      const selectedEU = region==='EU' ? collectSelectionsEU() : null;
      const selectedME = region==='ME' ? collectSelectionsME() : null;

      for(const item of fileStore){
        try{
          const rows=await readFileAsJson(item.file);
          const v=validateHeaders(rows); if(!v.isValid) throw new Error(`Missing headers: ${v.missing.join(', ')}`);
          const lang=item.file.name.split('.')[0].toUpperCase();

          let xml='';
          if(region==='EU'){
            const picks=(selectedEU && selectedEU[lang] && selectedEU[lang].length) ? selectedEU[lang] : EU_MARKETS?.[lang];
            xml=generateEuXml(rows, lang, mode, picks);
          }else{
            const picks=(selectedME && selectedME[lang] && Object.keys(selectedME[lang]).length) ? selectedME[lang] : ME_MARKETS?.[lang];
            xml=generateMeXml(rows, lang, mode, picks);
          }
          if(!xml) throw new Error(`Language '${lang}' not configured for ${region}.`);

          item.status='success'; item.message=''; success++;
          const fname=`000000000000000000000000000000_SEO_${region}_${lang}_${getFormattedDate()}.xml`;
          zip.file(fname, xml);
        }catch(err){
          item.status='error'; item.message=err.message;
        }
      }

      updateFileListUI();
      if(success>0){
        const blob=await zip.generateAsync({type:'blob'});
        saveAs(blob, `xml_files_${region}_${getFormattedDate()}.zip`);
        showStatus(`Successfully processed ${success} of ${fileStore.length} file(s).`,'success');
      }else{
        showStatus('No files were processed successfully. Check errors above.','error');
      }
      toggleLoading(false);
    }

    async function handlePreview(fileId){
      const item=fileStore.find(f=>f.id===fileId); if(!item) return;
      toggleLoading(true,'Generating preview...');
      try{
        const rows=await readFileAsJson(item.file);
        const v=validateHeaders(rows); if(!v.isValid) throw new Error(`Invalid headers. Missing: ${v.missing.join(', ')}`);
        const region=currentRegion();
        const mode=document.querySelector('input[name="mode"]:checked').value;
        const lang=item.file.name.split('.')[0].toUpperCase();

        const selectedEU=collectSelectionsEU();
        const selectedME=collectSelectionsME();

        let xml='';
        if(region==='EU'){
          const picks=(selectedEU && selectedEU[lang] && selectedEU[lang].length) ? selectedEU[lang] : EU_MARKETS?.[lang];
          xml=generateEuXml(rows, lang, mode, picks, true);
        }else{
          const picks=(selectedME && selectedME[lang] && Object.keys(selectedME[lang]).length) ? selectedME[lang] : ME_MARKETS?.[lang];
          xml=generateMeXml(rows, lang, mode, picks, true);
        }
        if(!xml) throw new Error('No XML could be generated.');

        modalContentCode.textContent=xml;
        modal.classList.remove('hidden');
        Prism.highlightAll();
      }catch(e){ showStatus(e.message,'error'); }
      finally{ toggleLoading(false); }
    }
  </script>
</body>
</html>
